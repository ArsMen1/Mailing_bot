from random import choice
from re import search, match
from mailing_bot.shp_mailing_bot.config import RESPONSIBLE_FOR_THE_BOT, GRADE_INFO_STATE_LINK
from tabulate import tabulate
from mailing_bot.logger_bot import logger

TOP_BAR_NPS = 80  # –≤—ã—Å–æ–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -- –æ—Ç 80 –∏ –≤—ã—à–µ
MEDIUM_BAR_NPS = 65  # —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -- –æ—Ç 65 –¥–æ 80
# –Ω–∏–∑–∫–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç -- –º–µ–Ω—å—à–µ 65

# —Å—Ä–µ–¥–Ω–∏–π NPS +15 –∏ -10

TOP_BAR_RETIREMENT = 4
MEDIUM_BAR_RETIREMENT = 8

are_you_really_prep_message = '–ù–µ –º–æ–≥—É –≤–∞—Å –Ω–∞–π—Ç–∏ –≤ –º–æ–µ–π —Ç–µ—Ç—Ä–∞–¥–æ—á–∫–µ, –≤—ã —Ç–æ—á–Ω–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å? ü•∏\n' \
                      f'–ï—Å–ª–∏ –¥–∞, —Ç–æ —Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ —ç—Ç–æ –º–æ–µ–π –º–∞–º–æ—á–∫–µ {RESPONSIBLE_FOR_THE_BOT}, ' \
                      f'–æ–Ω–∞ –≤–∞—Å –∑–∞–ø–∏—à–µ—Ç –∫–∞—Ä–∞–Ω–¥–∞—à–æ–º.'


# def ok_message() -> str:
#     ok_phrases = (
#         '–û–∫',
#         '–ü—Ä–∏–Ω—è—Ç–æ',
#         '–í—Å—ë —è—Å–Ω–æ',
#         '–í–æ—Å–ø—Ä–∏–Ω—è—Ç–æ',
#         '–ü–æ–Ω—è—Ç–Ω–æ –≤—Å—ë',
#         '–ê–≥–∞, –ø–æ–Ω—è—Ç–Ω–æ',
#         '–û–∫, —Å–ø–∞—Å–∏–±–æ',
#         '–û–±—â–µ–ø–æ–Ω—è—Ç–Ω–æ',
#         '–°—Ö–≤–∞—á–µ–Ω–æ',
#         '–ü—Ä–∏–Ω—è—Ç–æ',
#         '–î–æ—Å—Ç—É–ø–Ω–æ',
#         '–®–ü–∞—Å–∏–±–æ, –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ'
#     )
#
#     return choice(ok_phrases)


def kd_link_message() -> str:
    db_phrases = (
        '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞.',
        '–û–π! –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑—ã –Ω–∞ –æ–¥–Ω—É –º–∞–ª–µ–Ω—å–∫—É—é –∫–Ω–æ–ø–∫—É –ø—Ä–µ–≤—ã—à–µ–Ω–∞ ü§ì',
        '–ë–∞–∑–∞ –ó–Ω–∞–Ω–∏–π –æ–±–∏—Ç–∞–µ—Ç —Ç—É—Ç: ',
        '–í–æ—Ç —Å—Å—ã–ª–æ—á–∫–∞. –ò –±–æ–ª—å—à–µ –Ω–µ —Ç–µ—Ä—è–π—Ç–µ üôÉ',
        '–í–æ—Ç –∂–µ –æ–Ω–∞!',
        '–ù–∞–¥–µ—é—Å—å, –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ, —á—Ç–æ –∑–∞—Ö–æ–¥–∏—Ç–µ –≤ —Ö—Ä–∞–º —Ü–µ–Ω–Ω–µ–π—à–∏—Ö –∑–Ω–∞–Ω–∏–π –®–ü. –í–µ–¥–∏—Ç–µ —Å–µ–±—è —Ç–∏—Ö–æ ü§´',
        '–ü–æ—Ç–µ—Ä—è–ª–∏ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π? –õ–∞–∞–¥–Ω–æ, –¥–µ—Ä–∂–∏—Ç–µ üòå',
        '–ó–Ω–∞–∫–æ–º—å—Ç–µ—Å—å, –Ω–∞—à–∞ –≥–ª—É–±–æ–∫–æ —É–≤–∞–∂–∞–µ–º–∞—è –ë–∞–∑–∞ –ó–Ω–∞–Ω—å–µ–≤–Ω–∞ –®–ü–≤–æ–≤–Ω–∞ ',
        '–í–æ—Ç, –Ω–µ –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ',
        '–í–æ—Ç –æ–Ω, –Ω–∞—à —Å–≤—è–æ–π –≥—Ä–∞–∞–ª—å, –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å —Å –Ω–∏–º –±–µ—Ä–µ–∂–Ω–æ'
    )

    return choice(db_phrases)


def evaluation_indicator_message(nps: str = None, retirement: str = None) -> str:  # get comment for nps or retirement
    # phrases
    excellent_indicators_comments = (
        '–ö–∞–π—Ñ :)',
        '–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ü§©',
        '–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!',
        '–í–∞—É –≤–∞—É üòÄ',
        '–í–∞—Å —Ç–∞–∫ –ª—é–±—è—Ç —É—á–µ–Ω–∏–∫–∏ ü•∞',
        '–û—Ç–ª–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ üòå',
        '–û–≥–æ-–≥–æ, –∑–¥–æ—Ä–æ–≤–æ :)',
        '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ ‚ò∫Ô∏è',
        '–í—ã—Å—à–∏–π –ø–∏–ª–æ—Ç–∞–∂ ‚úàÔ∏è',
        '–ù–∏—á–µ–≥–æ —Å–µ–±–µ, –≤–æ—Ç —ç—Ç–æ –∫–ª–∞—Å—Å!',
        '–û–π, –∏–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ—Å—Ç–∏—Ç–µ, —è —á—Ç–æ, —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—é —Å –Ω–∞—Ä–æ–¥–Ω—ã–º –ª—é–±–∏–º—Ü–µ–º??',
        '–ê –º–æ–∂–Ω–æ –≤–∞—à –∞–≤—Ç–æ–≥—Ä–∞—Ñ?)',
        '–í–∞—É, –∫—Ä—É—Ç–æ üòÑ',
        '–≠—Ç–æ –∏—Å—Ç–æ—Ä–∏—è –ø—Ä–æ —É—Å–ø–µ—Ö üòé',
        '–û–±—Ä–∞–∑—Ü–æ–≤–æ-–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)',
        '–Æ—Ö—É—É ü§†',
        '–°–∏–ª—å–Ω–æ...',
        '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ üôÇ',
        '–ó–∞ –≤–∞–º–∏ —É–∂–µ –≤—ã–µ—Ö–∞–ª–∞ –ø–æ–ª–∏—Ü–∏—è –∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Ö–æ—Ä–æ—à–µ—Å—Ç–∏!!!',
        '–ó–Ω–∞–µ—Ç–µ, —è —Ö–æ—Ç–µ–ª –±—ã, —á—Ç–æ–±—ã –º–µ–Ω—è —Ç–æ–∂–µ —Ç–∞–∫ –∫—Ç–æ-–Ω–∏–±—É–¥—å –ª—é–±–∏–ª –∫–∞–∫ –≤–∞—Å –ª—é–±—è—Ç –¥–µ—Ç–∏ ü•∫'
    )

    good_indicators_comments = (
        '–•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ ‚ò∫Ô∏è',
        '–ù–µ–ø–ª–æ—Ö–æ!',
        '–ó–¥–æ—Ä–æ–≤–æ–æ–æ',
        '–ù–µ–ø–ª–æ—Ö–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç üôÇ',
        '–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, –∑–¥–æ—Ä–æ–≤–æ)',
        '–û—á–µ–Ω—å –Ω–µ–ø–ª–æ—Ö–æ. –î–∞–ª—å—à–µ ‚Äî –±–æ–ª—å—à–µ üí™',
        '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!',
    )

    bad_indicators_comment = (
        '–ú–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫–∞—Ç—å –µ—â—ë –ø–æ–¥—Ö–æ–¥ –∫ —Ä–µ–±—è—Ç–∞–º. –ù–µ–ø–æ–±–µ–¥–∏–º—ã—Ö –Ω–µ –±—ã–≤–∞–µ—Ç üí™',
        '–í—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é :)',
        '–ï—Å–ª–∏ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ, —á—Ç–æ –≤–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –ª—é–±–æ–º—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É –í–£–¶ üôÇ',
    )

    if nps and nps[-1] == '%':
        nps = float(nps.replace(',', '.')[:-1])
    if retirement and retirement[-1] == '%':
        retirement = retirement.replace(',', '.')[:-1]

    if (nps and nps >= TOP_BAR_NPS) or \
            (retirement and float(retirement) < TOP_BAR_RETIREMENT):
        return choice(excellent_indicators_comments)

    elif (nps and
          MEDIUM_BAR_NPS <= nps < TOP_BAR_NPS) or \
            (retirement and
             MEDIUM_BAR_RETIREMENT > float(retirement) >= TOP_BAR_RETIREMENT):
        return choice(good_indicators_comments)

    elif (nps and nps < MEDIUM_BAR_NPS) or \
            (retirement and float(retirement) >= MEDIUM_BAR_RETIREMENT):
        return choice(bad_indicators_comment)


def get_name_patronymic(name: str):
    name = name.split()
    if len(name) == 3 or len(name) == 4:  # 4 -- could be maiden name
        return " ".join(name[-2:])
    elif len(name) == 2:
        return name[-1]


def indicators_message(nps: str,
                       retirement: str,
                       average_nps: str,
                       average_retirement: str,
                       redflags: str,
                       actual_sem_flag: bool = False) -> tuple:
    """
    Returns a message and an indicators flag (are there indicators or not)
    """

    if not nps and not retirement:
        return '–û–π, –Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏ –≤–∞—à–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ üëâüèªüëàüèª\n\n' \
               '–ï—Å–ª–∏ –≤—ã –ø—Ä–µ–ø–æ–¥–∞—ë—Ç–µ –ø–µ—Ä–≤—ã–π —Å–µ–º–µ—Å—Ç—Ä, —Ç–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ–º–µ—Å—Ç—Ä–∞. ' \
               '–í–∞—à–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è\n\n' \
               f'–í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑—É –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ {RESPONSIBLE_FOR_THE_BOT}.', \
               False  # indicators flag

    nps_comment = ""
    retirement_comment = ""

    if actual_sem_flag:
        nps_comment = f'üí≠ `{evaluation_indicator_message(nps=nps)}`'
        retirement_comment = f'üí≠ `{evaluation_indicator_message(retirement=retirement)}`'

    message = f'üìå *–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏*'

    if nps:
        message += f'\n\n' \
                   f'*–í–∞—à NPS ‚Äî {nps}.*\n' \
                   f'–°—Ä–µ–¥–Ω–∏–π NPS –ø–æ —à–∫–æ–ª–µ ‚Äî {average_nps}.\n' + \
                   nps_comment
    else:
        message += '\n\n' \
                   '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É NPS —è –Ω–µ –Ω–∞—à—ë–ª –≤ —Å–≤–æ–µ–π –∫–Ω–∏–∂–µ—á–∫–µ üßê\n' \
                   f'–ï—Å–ª–∏ –≤—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫  {RESPONSIBLE_FOR_THE_BOT}'

    if retirement:
        message += f'\n\n' \
                   f'*–í–∞—à–∞ –≤—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å ‚Äî {retirement}.*\n' \
                   f'–°—Ä–µ–¥–Ω—è—è –≤—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å –ø–æ —à–∫–æ–ª–µ ‚Äî {average_retirement}.\n' + \
                   retirement_comment
    else:
        message += '\n\n' \
                   '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–π –≤—ã–±—ã–≤–∞–µ–º–æ—Å—Ç–∏ —è –Ω–µ –Ω–∞—à—ë–ª –≤ —Å–≤–æ–µ–π –∫–Ω–∏–∂–µ—á–∫–µ üßê\n' \
                   f'–ï—Å–ª–∏ –≤—ã –¥—É–º–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫  {RESPONSIBLE_FOR_THE_BOT}'

    if redflags:
        message += f'\n\n*–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–¥—Ñ–ª–∞–≥–æ–≤ ‚Äî *{redflags}.\n'

    return message, True


def current_group_detailing_nps_message(info):
    if not info:
        return ""

    result = f"\n\n\nüìå *–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≥—Ä—É–ø–ø–∞–º*\n\n"

    info = info.split("\n")
    table = []
    for s in info:
        item = s.split("\t")
        # logger.debug(item)
        curse = match(r"[–ê-–Ø–∞-—è–Å—ëA-Za-z/+\-]+", item[0])
        if not curse:
            return ""
        # group = search(r"_?\w\d{3}", item[0])
        group = item[0].split("-")
        if not group:
            pass
        item[0] = curse[0] + "-" + group[-2]
        table.append(item)
    result = result + "`" + tabulate(table, headers=["–ì—Ä—É–ø–ø–∞", "NPS"]) + "`"

    return result


grade_3_emoji = "üòÉüòÑüòÅüòÄü•∞üòçü§†"
grade_2_emoji = "üôÇüôÉüòäüòåü§óüòâ"
grade_1_emoji = "ü§®ü•∏üßêüò∂ü§îüôÑ"
grade_0_emoji = "üòîüòíüòïüôÅüòìüò∂üòµ‚Äçüí´"
grade_emoji = (grade_0_emoji, grade_1_emoji, grade_2_emoji, grade_3_emoji)


def grade_info_message(info, actual_sem=False):
    if not info:
        return ""
    result = "\n\n*–í–∞—à –≥—Ä–µ–π–¥ ‚Äî  "
    grade = info[:1]
    result += grade + f" {choice(grade_emoji[int(grade)])}" + "*"
    if actual_sem:
        result += f"\n–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –≥—Ä–µ–π–¥–∞, NPS –∏ —Ä–µ–¥—Ñ–ª–∞–≥–∞—Ö –º–æ–∂–µ—Ç–µ –ø–æ—á–∏—Ç–∞—Ç—å –≤ [—ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ]({GRADE_INFO_STATE_LINK})."
    return result

# def grade_info_message() -> str:
#     n = ' ' * 8
#
#     return '*–ì—Ä–µ–π–¥ 3:*\n' + \
#            n + 'NPS >=83%\n' + \
#            n + '–í—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å <= 7%\n' + \
#            n + '*ü§ë –ü—Ä–µ–º–∏—è ‚Äî 30%*\n\n' + \
#            '*–ì—Ä–µ–π–¥ 2:*\n' + \
#            n + 'NPS >= 72%\n' + \
#            n + '–í—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å <= 10%\n' + \
#            n + '*üí∞ –ü—Ä–µ–º–∏—è ‚Äî 15%*\n\n' + \
#            '*–ì—Ä–µ–π–¥ 1:*\n' + \
#            n + 'NPS  >= 60%\n' + \
#            n + '–í—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å <= 13%\n' + \
#            n + '*üíµ –ü—Ä–µ–º–∏—è ‚Äî 5%*\n\n' + \
#            '*–ì—Ä–µ–π–¥ 0:*\n' + \
#            n + 'NPS  < 60%\n' + \
#            n + '–í—ã–±—ã–≤–∞–µ–º–æ—Å—Ç—å > 13%\n' + \
#            n + '*üí∏ –ü—Ä–µ–º–∏—è ‚Äî 0%*\n\n' + \
#            '*–ò—Ç–æ–≥–æ–≤—ã–π –≥—Ä–µ–π–¥ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–∑ –¥–≤—É—Ö –≥—Ä–µ–π–¥–æ–≤ –ø–æ NPS –∏ –ø–æ –≤—ã–±—ã–≤–∞–µ–º–æ—Å—Ç–∏.*\n' \
#            '–ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ –≤—ã–±—ã–≤–∞–µ–º–æ—Å—Ç–∏ –≥—Ä–µ–π–¥ 2, –∞ –ø–æ NPS ‚Äî 3. \n–ò—Ç–æ–≥–æ–≤—ã–π –≥—Ä–µ–π–¥ ‚Äî 2.\n' \
#            '–¢–∞–∫–∂–µ –Ω–∞ –∏—Ç–æ–≥–æ–≤—ã–π –≥—Ä–µ–π–¥ –≤–ª–∏—è—é—Ç —Ä–µ–¥—Ñ–ª–∞–≥–∏.\n\n' \
#            '_–ó–∞ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥–ª—è–Ω—É—Ç—å –≤ —Å—Ç–∞—Ç—å—é –≤ –ë–∞–∑–µ –ó–Ω–∞–Ω–∏–π. ' \
#            '–°—Å—ã–ª–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞ –∫ –∫–Ω–æ–ø–∫–µ –Ω–∏–∂–µ._'
